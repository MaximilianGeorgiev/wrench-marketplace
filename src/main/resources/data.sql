DROP TABLE IF EXISTS LISTING;
DROP TABLE IF EXISTS IMAGE;
DROP TABLE IF EXISTS LISTING_IMAGE;
DROP TABLE IF EXISTS USERS;
DROP TABLE IF EXISTS USER_ROLE;
DROP TABLE IF EXISTS USER_LISTING;
DROP TABLE IF EXISTS ROLE;
DROP TABLE IF EXISTS LISTING_CATEGORY;

CREATE SCHEMA LISTING;

CREATE TABLE CATEGORY (
	Id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
	name VARCHAR(100) NOT NULL
);

/* prepopulate categories */
INSERT INTO CATEGORY (name) VALUES ('Car parts'), ('Car tools'), ('Tyres and rims'), ('Other');


CREATE TABLE LISTING (
  Id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
  title VARCHAR(25) NOT NULL,
  price DOUBLE NOT NULL,
  description VARCHAR(250) NOT NULL,
  category_name VARCHAR(25)
);

ALTER TABLE LISTING ADD FOREIGN KEY (category_name) REFERENCES CATEGORY(name) ON UPDATE CASCADE;

CREATE TABLE USERS (
  Id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(25) NOT NULL,
  password VARCHAR(250) NOT NULL,
  firstName VARCHAR(25) NOT NULL,
  secondName VARCHAR(25) NOT NULL,
  email VARCHAR(30) NOT NULL,
  age INT NOT NULL,
  enabled tinyint(1) NOT NULL
);

INSERT INTO USERS (Id, username, password, firstName, secondName, email, age, enabled) VALUES
(1, 'Gesh', '{bcrypt}$2a$04$eFytJDGtjbThXa80FyOOBuFdK2IwjyWefYkMpiBEFlpBwDH.5PM0K', 'Geshev', 'Gecuna', 'Gesh@gesh.ge', 30, 1);

CREATE TABLE ROLE (
Id INT PRIMARY KEY AUTO_INCREMENT,
name VARCHAR(250) NOT NULL
);

INSERT INTO ROLE (name)
VALUES 
('ROLE_USER'),('ROLE_ADMIN');

CREATE TABLE USER_ROLE (
user_Id INT,
role_Id INT
);

ALTER TABLE USER_ROLE ADD FOREIGN KEY(user_Id) REFERENCES USERS(Id) ON UPDATE CASCADE;
ALTER TABLE USER_ROLE  ADD FOREIGN KEY(role_Id) REFERENCES ROLE(Id) ON UPDATE CASCADE;

INSERT INTO USER_ROLE (user_id, role_id) VALUES
(1, 1);

CREATE TABLE IMAGE (
Id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
imageRoute VARCHAR(250)
);

CREATE TABLE LISTING_IMAGE (
listing_Id INT NOT NULL,
image_Id varchar(250) NOT NULL);

ALTER TABLE LISTING_IMAGE ADD FOREIGN KEY (listing_Id) REFERENCES LISTING(Id) ON UPDATE CASCADE;
ALTER TABLE LISTING_IMAGE ADD FOREIGN KEY (image_Id) REFERENCES IMAGE(Id) ON UPDATE CASCADE;

CREATE TABLE USER_LISTING (
user_Id INT NOT NULL,
listing_Id INT NOT NULL);

ALTER TABLE USER_LISTING ADD FOREIGN KEY (user_Id) REFERENCES USERS(Id) ON UPDATE CASCADE;
ALTER TABLE USER_LISTING ADD FOREIGN KEY (listing_Id) REFERENCES LISTING(Id) ON UPDATE CASCADE;


CREATE TABLE AUTHORITIES (
username VARCHAR(250) NOT NULL,
authority VARCHAR(250) NOT NULL,
UNIQUE KEY authorities_idx_1 (username, authority),
  CONSTRAINT authorities_ibfk_1 FOREIGN KEY (username) REFERENCES USERS (username)
);

INSERT INTO AUTHORITIES VALUES ('Gesh', 'ROLE_ADMIN');

